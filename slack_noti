#!/bin/bash

# Slack Webhook URL
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"

# 알림이 이미 전송된 세션을 기록할 파일
NOTIFIED_SESSIONS="notified_sessions.txt"

# 알림이 전송된 세션을 기록 파일에서 로드
if [ -f $NOTIFIED_SESSIONS ]; then
    mapfile -t notified < "$NOTIFIED_SESSIONS"
else
    notified=()
fi

# screen_으로 시작하는 모든 세션 이름을 확인하고, 종료된 세션에 대한 알림 전송
check_sessions() {
    # screen 세션 목록 중 screen_으로 시작하는 세션만 필터링
    current_sessions=$(screen -ls | grep -o 'screen_[^[:space:]]*' | sort | uniq)

    # 이미 알림이 전송된 세션을 제외하고, 종료된 세션에 대한 알림 전송
    for session in "${notified[@]}"; do
        if ! [[ " $current_sessions " =~ " $session " ]]; then
            send_slack_notification "$session"
            notified+=("$session")
            echo "$session" >> "$NOTIFIED_SESSIONS"
        fi
    done
}

# Slack 알림 전송 함수
send_slack_notification() {
    local session_name=$1
    curl -X POST -H 'Content-type: application/json' \
    --data "{\"text\":\"Screen session '$session_name' has terminated.\"}" \
    $SLACK_WEBHOOK_URL
}

# 주기적으로 세션 상태를 확인
while true; do
    check_sessions
    sleep 60  # 1분마다 확인
done
